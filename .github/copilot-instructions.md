# Copilot Instructions

## Project Overview

This is a **Task Tracker & Notes** app built on **Azure Functions v4** (Node.js) with **Azure Cosmos DB** (serverless NoSQL) and a **React 19** frontend built with **Vite**. It is deployed as a consumption-plan Function App on Azure.

## Architecture

```
client/              → React 19 + Vite frontend (builds to public/)
  src/
    App.jsx          → Root component with auth gate + tab navigation
    api.js           → API layer with Bearer token injection
    authConfig.js    → MSAL configuration for Entra ID
    notesApi.js      → API layer for folders/pages
    main.jsx         → MSAL initialization + MsalProvider
    components/      → React components (Header, TaskCard, NotesApp, PageEditor, etc.)
    styles.css       → All CSS (dark theme, CSS custom properties)
src/
  auth.js            → JWT validation middleware (Entra ID)
  cosmosClient.js    → Cosmos DB singleton client with local JSON fallback
  functions/
    tasks.js         → Task CRUD (5 HTTP triggers)
    comments.js      → Comment CRUD (2 HTTP triggers)
    folders.js       → Folder CRUD (4 HTTP triggers)
    pages.js         → Page CRUD (5 HTTP triggers)
    static.js        → Static file server + SPA fallback
public/              → Built frontend output (gitignored, generated by Vite)
```

## Tech Stack & Versions

- **Runtime**: Azure Functions v4 (`@azure/functions ^4.5.0`), Node.js 20 (Azure) / 24 (local)
- **Database**: Azure Cosmos DB NoSQL serverless (`@azure/cosmos ^4.2.0`)
- **Frontend**: React 19 + ReactDOM 19 (devDependencies, not shipped to Azure)
- **Build**: Vite 7 with `@vitejs/plugin-react`
- **IDs**: `uuid` v9 for all entity IDs
- **Auth**: Microsoft Entra ID (Azure AD) via `jsonwebtoken` + `jwks-rsa` (backend), `@azure/msal-browser` + `@azure/msal-react` (frontend)
- **Deployment**: `func azure functionapp publish taskstracker-func`

## Key Patterns

### Azure Functions

- All functions use the **v4 programming model** with `app.http()` registration.
- Auth level is `anonymous` — authentication is handled in application code via `authenticate()` middleware.
- Every API handler calls `authenticate(request)` first and returns 401 if null.
- Routes are explicitly set (e.g., `route: 'api/tasks/{id}'`).
- `host.json` sets `routePrefix: ""` so routes include the `api/` prefix themselves.
- Functions return `{ status, jsonBody }` or `{ status, body, headers }` objects.
- Always destructure containers from `await getContainers()` at the start of each handler.

```javascript
// Example function pattern
const { app } = require('@azure/functions');
const { getContainers } = require('../cosmosClient');
const { authenticate } = require('../auth');
const { v4: uuidv4 } = require('uuid');

app.http('myFunction', {
  methods: ['POST'],
  authLevel: 'anonymous',
  route: 'api/resource',
  handler: async (request, context) => {
    const user = await authenticate(request);
    if (!user) return { status: 401, jsonBody: { error: 'Unauthorized' } };

    try {
      const { myContainer } = await getContainers();
      const body = await request.json();
      const item = { id: uuidv4(), userId: user.userId, ...body };
      // ... logic
      return { status: 201, jsonBody: result };
    } catch (err) {
      context.error('Error:', err);
      return { status: 500, jsonBody: { error: 'Internal server error' } };
    }
  }
});
```

### Cosmos DB

- **Database**: `tasktracker`
- **Containers & partition keys**:
  - `tasks` → `/partitionKey` (value: `"task"`)
  - `comments` → `/taskId`
  - `folders` → `/partitionKey` (value: `"folder"`)
  - `pages` → `/folderId`
- **Serverless tier** — no composite indexes available; use single-field `ORDER BY` in queries and sort in-memory for secondary fields.
- Queries use parameterized SQL: `{ query: '...', parameters: [{ name: '@x', value: x }] }`.
- The `cosmosClient.js` module provides a **local JSON fallback** (`data.json`) when `COSMOS_ENDPOINT` is not set, enabling offline development without Azure.

### React Frontend

- Vite builds `client/` → `public/` (the `public/` directory is gitignored).
- React and ReactDOM are **devDependencies** to keep Azure deployments lean (~9 MB).
- The app uses **functional components with hooks** (useState, useEffect, useCallback).
- **Authentication** via MSAL: `MsalProvider` wraps the app, `useIsAuthenticated` / `useMsal` hooks gate content.
- `api.js` automatically attaches `Authorization: Bearer <token>` headers to all API requests.
- No routing library — tab switching between Tasks and Notes is via `activeTab` state in `App.jsx`.
- API calls go through thin wrapper functions in `api.js` and `notesApi.js` that call `fetch()`.
- CSS uses a single `styles.css` file with CSS custom properties (`:root` variables) for theming.

### Static File Serving

- `static.js` serves files from `public/` with proper MIME types.
- It has a catch-all route `{*filepath}` and falls back to `index.html` for SPA routing.

## Development Workflow

```powershell
# Install dependencies
npm install

# Run Vite dev server (hot reload, proxies /api to localhost:7071)
npm run dev

# Run Azure Functions locally (separate terminal)
npm run dev:api

# Build frontend for production
npm run build

# Deploy to Azure
npm prune --production
func azure functionapp publish taskstracker-func
npm install  # restore devDeps after deploy
```

## Important Constraints

1. **500 character limit** on note page content (validated in `pages.js` backend).
2. **No composite indexes** — Cosmos DB serverless doesn't support them. Sort in-memory after query.
3. **`public/` is gitignored** — always run `npm run build` before deploying or testing locally with `func start`.
4. **`.funcignore`** excludes `client/`, `vite.config.js`, and other dev files from Azure deployment.
5. **`local.settings.json`** contains secrets and is gitignored. Use `local.settings.sample.json` as a template.
6. **Authentication** — all API endpoints require a valid Entra ID JWT token. Without `AZURE_TENANT_ID`/`AZURE_CLIENT_ID` set, auth falls back to a mock `local-dev` user for development.
7. **Per-user data isolation** — every entity stores `userId`, every query filters by it. Users can only see/modify their own data.

## Code Style

- CommonJS `require()` for backend (Azure Functions Node.js).
- ES modules `import/export` for frontend React code.
- Consistent error handling with try/catch in all function handlers.
- Use `uuidv4()` for generating all entity IDs.
- CSS class naming: kebab-case (e.g., `.task-card`, `.notes-sidebar`, `.page-editor`).
- Component naming: PascalCase files and exports (e.g., `TaskCard.jsx`, `PageEditor.jsx`).

## Notes Feature Formatting

- Lines starting with `# ` render as **bold headings**.
- Lines starting with `- ` render as **bullet points**.
- All other lines render as plain text.
- The `parseContent()` function in `PageEditor.jsx` handles this formatting in preview mode.
